# This is an example Starter pipeline configuration
# Use a skeleton to build, test and deploy using manual and parallel steps
# -----
# You can specify a custom docker image from Docker Hub as your build environment.

options:
    max-time: 120
    size: "2x"

image: node:18.8.0

pipelines:
    branches:
        development: #name of your test branch
            - step:
                  name: "Install dependencies"
                  image: node:18.8.0
                  caches:
                      - gradle
                      - node
                  script:
                      - echo JAVA_HOME=$JAVA_HOME > .env
                      - echo GOOGLE_MAPS_API_KEY=$GOOGLE_MAPS_API_KEY >> .env
                      - echo API_URL_COMMON=$API_URL_COMMON >> .env
                      - echo API_URL_INV=$API_URL_INV >> .env
                      - echo API_URL_PRODUCTIVITY=$API_URL_PRODUCTIVITY >> .env
                      - echo API_URL_ORDER=$API_URL_ORDER >> .env
                      - echo API_URL_FINANCE=$API_URL_FINANCE >> .env
                      - cat .env
                      - yarn install

            - step:
                  name: "Build Android"
                  image: mingc/android-build-box:latest
                  caches:
                      - node
                  script: # Modify the commands below to build your repository
                      - cd android
                      - yarn androidRelease-Dev
                  artifacts:
                      - android/app/build/outputs/**

            - step:
                  name: "Release to App Center"
                  deployment: Development
                  script:
                      - yarn global add appcenter-cli
                      - COMMIT_MSG=$(git log --format=%B -n 1 $BITBUCKET_COMMIT)
                      - appcenter distribute release --group Collaborators --file "android/app/build/outputs/bundle/developmentRelease/app-development-release.aab" --release-notes "$COMMIT_MSG" --app $APP_CENTER_APP_NAME --token $APP_CENTER_API_TOKEN --quiet
        release/*: #name of your test branch
            - step:
                  name: "Install dependencies"
                  image: node:18.8.0
                  caches:
                      - gradle
                      - node
                  script:
                      - yarn install

            - step:
                  name: "Build Android"
                  image: mingc/android-build-box:latest
                  caches:
                      - node

                  script: # Modify the commands below to build your repository
                      - cd android
                      - yarn androidRelease-Dev
                  artifacts:
                      - android/app/build/outputs/**

            - step:
                  name: "Release to App Center"
                  deployment: Development
                  script:
                      - yarn global add appcenter-cli
                      - COMMIT_MSG=$(git log --format=%B -n 1 $BITBUCKET_COMMIT)
                      - appcenter distribute release --group Collaborators --file "android/app/build/outputs/bundle/developmentRelease/app-development-release.aab" --release-notes "$COMMIT_MSG" --app $APP_CENTER_APP_NAME --token $APP_CENTER_API_TOKEN --quiet
        hotfix/*: #name of your test branch
            - step:
                  name: "Install dependencies"
                  image: node:18.8.0
                  caches:
                      - gradle
                      - node
                  script:
                      - yarn install

            - step:
                  name: "Build Android"
                  image: mingc/android-build-box:latest
                  caches:
                      - node
                  script: # Modify the commands below to build your repository
                      - cd android
                      - yarn androidRelease
                  artifacts:
                      - android/app/build/outputs/**

            - step:
                  name: "Release to App Center"
                  deployment: Production
                  script:
                      - yarn global add appcenter-cli
                      - COMMIT_MSG=$(git log --format=%B -n 1 $BITBUCKET_COMMIT)
                      - appcenter distribute release --group Collaborators --file "android/app/build/outputs/bundle/productionRelease/app-production-release.aab" --release-notes "$COMMIT_MSG" --app $APP_CENTER_APP_NAME --token $APP_CENTER_API_TOKEN --quiet
        main: #name of your test branch
            - step:
                  name: "Install dependencies"
                  image: node:18.8.0
                  caches:
                      - gradle
                      - node
                  script:
                      - yarn install

            - step:
                  name: "Build Android"
                  caches:
                      - node
                  image: mingc/android-build-box:latest

                  script: # Modify the commands below to build your repository
                      - cd android
                      - yarn androidRelease
                  artifacts:
                      - android/app/build/outputs/**

            - step:
                  name: "Release to App Center"
                  deployment: Production
                  script:
                      - yarn global add appcenter-cli
                      - COMMIT_MSG=$(git log --format=%B -n 1 $BITBUCKET_COMMIT)
                      - appcenter distribute release --group Collaborators --file "android/app/build/outputs/bundle/productionRelease/app-production-release.aab" --release-notes "$COMMIT_MSG" --app $APP_CENTER_APP_NAME --token $APP_CENTER_API_TOKEN --quiet
